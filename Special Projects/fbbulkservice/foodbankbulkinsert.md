# Food Bank Bulk Service Upload

## Project Background

The Gallatin Valley Food Bank had a list of 1039 holiday food boxes that they distributed, and they wanted these to be uploaded to CaseWorthy as services. The data the provided had first name, last name, and # in household, but no CaseWorthy client ID.

## Steps

1. Match names to client IDs
1. Find enrollment IDs for matching clients
1. Generate SQL insert statement derived from original data, client ID, and enrollment ID.
1. Generate SQL insert statement for indirect services
   - This was done for clients who could not be matched to an existing client
   - Ideally these people would be created as new clients, but I thought it wasn't worth while due to lack of information about them. The risk of creating a huge number of duplicates was too high.
1. Existing clients that couldn't be matched on the first pass were manually entered by food bank staff
   
   
## Components

### Python

#### [holidaybox.py](holidaybox.py)

This script process data from the excel sheet and invokes the sqlgetter.py to look up client information

- Constants
  - `services` is a dataframe created from raw spreadsheet data. It only contains rows that are not anonymous
  - `indirect_services` is a dataframe created from processed spreadsheet data. It only contains rows that could not be matched to a client in CaseWorthy.
  
##### Functions

###### `name_search(first_name, last_name)` 

- Takes two name strings as parameters.
- Searches CaseWorthy for clients matching those names exactly.
- Returns all matches.
  
###### `enrollment_id(data)`

- Takes an int for EntityID as a parameter.
- Searches CaseWorthy for a Universal Intake enrollment ID with an Entity ID matching the parameter.
- Returns all matches.
  
###### `generate_sql(data)`
- Takes a DataFrame with client service data as a parameter
- Iterates over each row of service data to generate SQL code.
- Opens and appends to [bulkinsert.sql](bulkinsert.sql)
- No return value
    
###### `generate_indirect_service(data)`
- Takes a DataFrame with client service data as a parameter
- Used for clients that could not be matched to existing records
- Differs from `generate_sql(data)` in that it has hardcoded values for Entity ID and Enrollment ID, corresponding to the "indirect service" client in CaseWorthy.
- No return value
  
###### `create_script()`
- Driver function for the whole script.
- Invokes `name_search(first_name, last_name)` to match service records to client records
- Invokes `enrollment_id(data)` to match client records to enrollment IDs
- Runs `generate_sql(data)` and `create_indirect_service(data)` on processed records
- Generates lists of hard matches, soft matches, and no matches.


#### [sqlgetter.py](sqlgetter.py)
A utility to connect python to a SQL server

- Constants
  - `server` points at the local SQL Express server
    - '[Your Computer Name]\\\\[Your Server Name]'
  - `database` points at the database located on `server`
    - 'HRDC09_Prod' in this case
    
##### Functions

###### `connect(server, database)`
- Uses `pyodbc` to connect to a given SQL server
- Returns a connection object

###### `pandize_data(query)`
- Takes a name of a SQL file as a parameter
  - The query must be in the same directory as the script
- Uses `pd.read_sql_query(query, connection)` to generate a dataframe from the specified query
- This function has the connection hard coded to the return value of `connect(server,database)`

- SQL
  - [qu.sql](qu.sql)
    - Searches for a client by first and last name.
    - `'*FIRST NAME*'` and `'*LAST NAME*'` are set by `name_search(first_name, last_name)`
  - [enrollments.sql](enrollments.sql)
    - Searches for a universal intake enrollment ID by client ID
    - `**Entity ID**` is set by `enrollment_id(data)`
  - [bulkinsert.sql](bulkinsert.sql)
    - The final script generated by `create_script()` in [holidaybox.py](holidaybox.py)
    - Creates 709 new Service records
- Spreadsheets